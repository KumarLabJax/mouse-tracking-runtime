# build like:
#   singularity build --fakeroot deployment-runtime.sif deployment-runtime-RHEL9.def
# This image is compliant with RHEL 7-8 host OS, not 9.
# Please use the other definition file for RHEL 9 host OS.

Bootstrap: docker
From: nvcr.io/nvidia/tensorrt:24.01-py3

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/kumar-lab-models/deployment-runtime/
    mkdir -p ${SINGULARITY_ROOTFS}/kumar-lab-models/models/

%files
    ../requirements.txt /kumar-lab-models/.
    ../README.md /kumar-lab-models/.
    ../deployment-runtime /kumar-lab-models/
    ../models /kumar-lab-models/

%post
    apt-get -y update
    apt-get -y install less ffmpeg python3-pip libsm6 libxext6 libxrender-dev libjpeg8-dev zlib1g-dev
    apt-get -y clean

    # Upgrade pip
    pip3 install --upgrade pip
    pip3 install -r /kumar-lab-models/requirements.txt
    pip install --upgrade onnxruntime-gpu --extra-index-url https://aiinfra.pkgs.visualstudio.com/PublicPackages/_packaging/onnxruntime-cuda-12/pypi/simple/
